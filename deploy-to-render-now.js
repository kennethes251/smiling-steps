const fs = require('fs');

console.log('ğŸš€ Deploying to Render - Production Ready!');
console.log('==========================================');

const checkPreDeployment = () => {
  console.log('\n1. Pre-deployment Checklist:');
  
  // Check if .env exists
  if (fs.existsSync('.env')) {
    console.log('âœ… .env file exists');
    const envContent = fs.readFileSync('.env', 'utf8');
    
    if (envContent.includes('MONGODB_URI')) {
      console.log('âœ… MongoDB connection configured');
    }
    
    if (envContent.includes('JWT_SECRET')) {
      console.log('âœ… JWT secret configured');
    }
    
    if (envContent.includes('EMAIL_USER')) {
      console.log('âœ… Email configuration found');
    }
  }
  
  // Check package.json
  if (fs.existsSync('package.json')) {
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    if (packageJson.scripts && packageJson.scripts.start) {
      console.log('âœ… Start script configured');
    }
    if (packageJson.engines && packageJson.engines.node) {
      console.log('âœ… Node version specified');
    }
  }
  
  // Check render.yaml
  if (fs.existsSync('render.yaml')) {
    console.log('âœ… Render configuration exists');
  }
};

const createRenderYaml = () => {
  console.log('\n2. Creating/Updating render.yaml:');
  
  const renderConfig = `services:
  - type: web
    name: smiling-steps-backend
    env: node
    plan: free
    buildCommand: npm install
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        fromDatabase:
          name: smiling-steps-mongodb
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: EMAIL_USER
        value: kennethes251@gmail.com
      - key: EMAIL_PASSWORD
        value: gmhp uzew qwpl zepz
      - key: FROM_EMAIL
        value: hr@smilingsteps.com
      - key: FROM_NAME
        value: Smiling Steps
      - key: CLIENT_URL
        value: https://smiling-steps-frontend.onrender.com

  - type: web
    name: smiling-steps-frontend
    env: static
    plan: free
    buildCommand: cd client && npm install && npm run build
    staticPublishPath: ./client/build
    envVars:
      - key: REACT_APP_API_URL
        value: https://smiling-steps-backend.onrender.com

databases:
  - name: smiling-steps-mongodb
    databaseName: smiling-steps
    user: smiling-steps-user
`;

  fs.writeFileSync('render.yaml', renderConfig);
  console.log('âœ… Created render.yaml configuration');
};

const updatePackageJson = () => {
  console.log('\n3. Ensuring package.json is production ready:');
  
  const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
  
  // Ensure engines are specified
  if (!packageJson.engines) {
    packageJson.engines = {};
  }
  packageJson.engines.node = '18.x';
  
  // Ensure start script is correct
  if (!packageJson.scripts) {
    packageJson.scripts = {};
  }
  packageJson.scripts.start = 'node index.js';
  
  fs.writeFileSync('package.json', JSON.stringify(packageJson, null, 2));
  console.log('âœ… Package.json updated for production');
};

const createClientPackageJson = () => {
  console.log('\n4. Checking client package.json:');
  
  if (fs.existsSync('client/package.json')) {
    const clientPackage = JSON.parse(fs.readFileSync('client/package.json', 'utf8'));
    
    // Ensure build script exists
    if (!clientPackage.scripts) {
      clientPackage.scripts = {};
    }
    
    if (!clientPackage.scripts.build) {
      clientPackage.scripts.build = 'react-scripts build';
    }
    
    fs.writeFileSync('client/package.json', JSON.stringify(clientPackage, null, 2));
    console.log('âœ… Client package.json ready for build');
  } else {
    console.log('âš ï¸  Client package.json not found - frontend deployment may need manual setup');
  }
};

const createDeploymentGuide = () => {
  console.log('\n5. Creating deployment guide:');
  
  const guide = `# ğŸš€ Render Deployment Guide

## Your App is Ready to Deploy!

### Option 1: Automatic Deployment (Recommended)

1. **Connect to GitHub:**
   - Push your code to GitHub
   - Go to https://render.com
   - Sign up/login with GitHub
   - Click "New" â†’ "Blueprint"
   - Connect your repository

2. **Environment Variables:**
   Render will automatically set up most variables, but verify these:
   \`\`\`
   MONGODB_URI=<your-mongodb-atlas-connection>
   JWT_SECRET=<auto-generated>
   EMAIL_USER=kennethes251@gmail.com
   EMAIL_PASSWORD=gmhp uzew qwpl zepz
   \`\`\`

### Option 2: Manual Deployment

1. **Backend Service:**
   - Go to Render Dashboard
   - Click "New" â†’ "Web Service"
   - Connect GitHub repo
   - Settings:
     - Build Command: \`npm install\`
     - Start Command: \`npm start\`
     - Environment: Node

2. **Frontend Service:**
   - Click "New" â†’ "Static Site"
   - Connect same GitHub repo
   - Settings:
     - Build Command: \`cd client && npm install && npm run build\`
     - Publish Directory: \`client/build\`

### Your URLs (after deployment):
- **Backend API:** https://smiling-steps-backend.onrender.com
- **Frontend App:** https://smiling-steps-frontend.onrender.com

### Environment Variables to Set:
\`\`\`
NODE_ENV=production
MONGODB_URI=mongodb+srv://KennethEsilo:9213@cluster0.m7v7wpi.mongodb.net/smiling-steps?retryWrites=true&w=majority&appName=Cluster0
JWT_SECRET=your-super-secret-production-key
EMAIL_USER=kennethes251@gmail.com
EMAIL_PASSWORD=gmhp uzew qwpl zepz
FROM_EMAIL=hr@smilingsteps.com
FROM_NAME=Smiling Steps
CLIENT_URL=https://smiling-steps-frontend.onrender.com
\`\`\`

### Testing After Deployment:
1. Visit your frontend URL
2. Test registration/login
3. Check API endpoints: \`https://your-backend.onrender.com/api/test\`

## ğŸ‰ Your App Features:
- âœ… User Registration & Login
- âœ… Psychologist Profiles
- âœ… Session Booking
- âœ… Video Calls
- âœ… Admin Dashboard
- âœ… Blog System
- âœ… M-Pesa Payments
- âœ… Email Notifications

## Support:
- MongoDB Atlas: Already configured âœ…
- Email: Gmail SMTP ready âœ…
- Payments: M-Pesa sandbox ready âœ…
`;

  fs.writeFileSync('RENDER_DEPLOYMENT_GUIDE.md', guide);
  console.log('âœ… Created deployment guide');
};

const createGitCommands = () => {
  console.log('\n6. Git deployment commands:');
  
  const commands = `# ğŸš€ Deploy to Render Commands

# 1. Commit your changes
git add .
git commit -m "Ready for production deployment"

# 2. Push to GitHub (if not already done)
git push origin main

# 3. Go to Render.com and connect your repository

# 4. Your app will be live at:
# Backend: https://smiling-steps-backend.onrender.com
# Frontend: https://smiling-steps-frontend.onrender.com
`;

  fs.writeFileSync('DEPLOY_COMMANDS.md', commands);
  console.log('âœ… Created git deployment commands');
};

const main = () => {
  checkPreDeployment();
  createRenderYaml();
  updatePackageJson();
  createClientPackageJson();
  createDeploymentGuide();
  createGitCommands();
  
  console.log('\nğŸ‰ Deployment Preparation Complete!');
  console.log('===================================');
  console.log('');
  console.log('ğŸš€ Next Steps:');
  console.log('1. git add .');
  console.log('2. git commit -m "Ready for deployment"');
  console.log('3. git push origin main');
  console.log('4. Go to https://render.com');
  console.log('5. Connect your GitHub repository');
  console.log('6. Deploy using the render.yaml blueprint');
  console.log('');
  console.log('ğŸ“– Read RENDER_DEPLOYMENT_GUIDE.md for detailed instructions');
  console.log('');
  console.log('ğŸŒ Your app will be live in ~5-10 minutes!');
};

main();